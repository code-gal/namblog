# 网站统计脚本配置说明

## 功能介绍

NamBlog 支持通过配置文件动态嵌入网站统计脚本（如 Umami、Google Analytics、百度统计等），无需修改前端代码。

## 配置方式

### 方式一：配置文件（推荐）

在 `data/config/config.json` 中添加 `AnalyticsScript` 字段：

```json
{
  "Blog": {
    "BlogName": "我的博客",
    "Blogger": "博主",
    "AnalyticsScript": "<script async defer data-website-id=\"your-website-id\" src=\"https://analytics.yourdomain.com/script.js\"></script>"
  }
}
```

### 方式二：环境变量（Docker 部署）

在 Docker Compose 或容器启动时设置环境变量：

```yaml
# docker-compose.yml
services:
  namblog:
    environment:
      - Blog__AnalyticsScript=<script async defer data-website-id="your-id" src="https://analytics.yourdomain.com/script.js"></script>
```

或命令行：

```bash
docker run -e 'Blog__AnalyticsScript=<script async defer data-website-id="your-id" src="https://analytics.yourdomain.com/script.js"></script>' ...
```

## 支持的统计平台

### 1. Umami（推荐）

Umami 是一个轻量级、开源、隐私友好的网站统计工具。

```json
{
  "AnalyticsScript": "<script async defer data-website-id=\"your-website-id\" src=\"https://analytics.yourdomain.com/script.js\"></script>"
}
```

### 2. Google Analytics 4

```json
{
  "AnalyticsScript": "<script async src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX\"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-XXXXXXXXXX');</script>"
}
```

### 3. 百度统计

```json
{
  "AnalyticsScript": "<script>var _hmt = _hmt || [];(function() {var hm = document.createElement(\"script\");hm.src = \"https://hm.baidu.com/hm.js?your-baidu-token\";var s = document.getElementsByTagName(\"script\")[0];s.parentNode.insertBefore(hm, s);})();</script>"
}
```

### 4. 51.la（无埋点统计）

```json
{
  "AnalyticsScript": "<script charset=\"UTF-8\" id=\"LA_COLLECT\" src=\"//sdk.51.la/js-sdk-pro.min.js\"></script><script>LA.init({id:\"your-51la-id\",ck:\"your-51la-key\"})</script>"
}
```

## 配置说明

### 热重载支持

Blog 配置支持热重载，修改 `config.json` 后**无需重启应用**，刷新前端页面即可生效。

### 安全性

- 统计脚本由管理员配置，仅在服务端配置文件中存储
- 前端通过 GraphQL API 获取脚本后动态注入
- 建议只使用可信的统计服务提供商

### 注意事项

1. **HTML 转义**：在 JSON 中配置时，确保正确转义双引号或使用单引号
2. **多个脚本**：如果需要同时使用多个统计平台，可以将多个 `<script>` 标签拼接在一起
3. **异步加载**：建议统计脚本使用 `async` 或 `defer` 属性，避免阻塞页面加载
4. **空值处理**：留空或不配置该字段则不会加载任何统计脚本

### 示例：多个统计脚本

```json
{
  "AnalyticsScript": "<script async defer data-website-id=\"umami-id\" src=\"https://analytics.example.com/script.js\"></script><script async src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\"></script>"
}
```

## 技术实现

### 后端

1. [BlogInfo.cs](../NamBlog.API/Application/DTOs/BlogInfo.cs#L48) - 添加 `AnalyticsScript` 属性
2. [BlogBasicType.cs](../NamBlog.API/EntryPoint/GraphiQL/Queries/BlogBasicType.cs#L61) - GraphQL Schema 定义
3. 配置文件支持热重载（`IOptionsSnapshot<BlogInfo>`）

### 前端

1. [Footer.js](../NamBlog.Web/js/components/Footer.js) - GraphQL 查询获取脚本
2. 动态创建 `<script>` 标签并注入到页面底部
3. 错误容错处理，统计脚本加载失败不影响正常使用

## 验证方法

1. 修改配置文件添加统计脚本
2. 刷新前端页面
3. 打开浏览器开发者工具（F12）
4. 检查 Network 标签页，确认统计脚本已加载
5. 检查 Console 标签页，确认无报错信息
6. 访问统计平台查看数据是否正常上报

## 常见问题

### Q: 配置后没有生效？

A: 检查以下几点：
- JSON 格式是否正确（注意转义）
- 刷新前端页面（Ctrl+F5 强制刷新）
- 检查浏览器控制台是否有错误
- 确认统计脚本的 URL 是否正确

### Q: 是否支持环境变量配置？

A: 是的，使用双下划线分隔：`Blog__AnalyticsScript`

### Q: 配置后多久生效？

A: Blog 配置支持热重载，修改后立即生效，前端刷新页面即可。

### Q: 统计脚本会影响页面性能吗？

A: 使用 `async` 或 `defer` 属性可以避免阻塞页面渲染，对性能影响极小。
