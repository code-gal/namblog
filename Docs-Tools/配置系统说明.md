# 配置系统说明

## 配置文件概览

NamBlog 使用以下配置文件：

| 配置文件 | 位置 | 用途 | 热重载 |
|---------|------|------|--------|
| **config.json** | `data/config/` | 博客基本配置（博客信息、AI、CORS等） | 部分支持 |
| **prompts.json** | `data/config/` | AI 内容生成系统提示词和规则配置 | ✅ 支持 |
| **mcp-prompts.json** | `data/config/` | MCP 客户端使用的提示词模板 | ✅ 支持 |

**自动初始化机制**：
- config.json需要预先自定义，另外两个配置在首次启动时，如果 `data/config/` 目录不存在，系统会自动从 `wwwroot/config/` 复制模板文件
- Docker 容器部署时，会自动将配置文件映射到宿主机的 `./data/config/` 目录，方便用户后续自定义

## 配置加载顺序

配置按以下顺序加载，后加载的配置会覆盖先加载的配置：

```
1. appsettings.json              (默认配置)
2. appsettings.Development.json  (开发环境配置)
3. data/config/config.json       (用户自定义配置，Docker 挂载)
4. 环境变量                      (敏感信息：JWT Secret、API Key 等)
```

## 配置热重载支持

NamBlog 支持以下配置的**热重载**（修改后无需重启应用）：

| 配置项 | 热重载支持 | 说明 |
|--------|----------|------|
| **Blog** | ✅ 支持 | 博客名称、头像等信息修改后立即生效 |
| **AI** | ✅ 支持 | Model、Temperature 等参数修改后立即生效 |
| **Cors** | ✅ 支持 | 跨域配置修改后立即生效 |
| **Logging** | ✅ 支持 | 日志级别修改后立即生效 |
| **FileWatcher** | ⚠️ 需重启 | 文件监控配置修改后需要重启应用 |
| **Storage** | ❌ 不可配 | 数据目录路径不可在 config.json 中配置 |
| **Admin** | ⚠️ 需重启 | 管理员账号配置修改后需要重启应用 |
| **Jwt** | ⚠️ 需重启 | JWT 配置修改后需要重启应用 |
| **MCP** | ⚠️ 需重启 | MCP 配置修改后需要重启应用 |

### 技术说明

- **BlogSettings**: 使用 `IOptionsSnapshot<T>`，每次 GraphQL 请求时更新
- **AISettings**: 使用 `IOptionsMonitor<T>`，实时监控配置变化
- **其他配置**: 使用 `IOptions<T>`，应用启动时绑定，需重启才能更新

## 用户自定义配置

### 配置文件位置

- **模板文件**：`/wwwroot/config/config.json.template`
- **实际配置**：`data/config/config.json`（需手动创建）

### 使用方法

1. **首次配置**：
   ```bash
   copy /wwwroot/config/config.json.template data/config/config.json
   ```

2. **修改配置**：
   编辑 `config.json`，仅保留需要覆盖的配置项

3. **配置生效**：
   - **支持热重载的配置**（Blog、AI、Cors、Logging）：修改后立即生效
   - **需要重启的配置**（Admin、Jwt、MCP、FileWatcher）：修改后需重启应用
   ```bash
   # 重启应用（Windows PowerShell）
   # 在运行应用的终端按 Ctrl+C，然后：
   dotnet run
   
   # Docker 环境
   docker restart 
   ```

### 配置示例

**最小配置**（仅修改博客信息）：
```json
{
  "Blog": {
    "BlogName": "我的技术博客",
    "Blogger": "张三",
    "Email": "zhangsan@example.com"
  }
}
```

**完整配置**（覆盖所有可配置项）：
```json
{
  "Blog": {
    "BlogName": "我的博客",
    "Blogger": "博主昵称",
    "Icon": "/files/icon/favicon.ico",
    "Email": "your-email@example.com",
    "Domain": "https://yourdomain.com",
    "Slogan": "这是我的个人博客",
    "Avatar": "/files/icon/avatar.jpg",
    "AnalyticsScript": "<script async defer data-website-id=\"your-website-id\" src=\"https://analytics.example.com/script.js\"></script>",
    "OuterChains": [
      {
        "Name": "GitHub",
        "Link": "https://github.com/yourusername",
        "SVG": "/files/icon/github.svg"
      }
    ]
  },
  "AI": {
    "Model": "gpt-4",
    "Temperature": "0.7"
  },
  "Cors": {
    "AllowedOrigins": "http://localhost:3000,https://yourdomain.com"
  }
}
```

## 重要配置项说明

### 不可在 config.json 中配置的项

以下配置项**仅能**通过 `appsettings.json`、`appsettings.Local.json` 或**环境变量**修改：

- **Storage.DataRootPath**：数据目录路径
  - 原因：存在循环依赖（需要先知道数据目录才能加载 config.json）
  - 修改方法：
    ```bash
    # Windows (PowerShell)
    $env:Storage__DataRootPath = "D:\MyData"
    
    # Linux/Mac
    export Storage__DataRootPath=/var/namblog/data
    
    # Docker
    docker run -e Storage__DataRootPath=/app/data ...
    ```

### 静态资源路径规范

- **图标路径**：使用 `/resources/icon/...`（对应 `data/resources/icon/`）
- **文章 HTML**：通过 `/posts/{slug}/v{version}/index.html` 访问
- **示例**：
  ```json
  {
    "Blog": {
      "Icon": "/resources/icon/favicon.ico",
      "Avatar": "/resources/icon/my-avatar.png",
      "SVG": "/resources/icon/github.svg"
    }
  }
  ```

### 网站统计脚本配置

支持在页脚嵌入第三方统计脚本（如 Umami、Google Analytics 等）：

- **配置项**：`Blog.AnalyticsScript`
- **热重载**：✅ 支持，修改后立即生效
- **详细说明**：参见 [网站统计脚本配置说明](网站统计脚本配置说明.md)
- **示例**：
  ```json
  {
    "Blog": {
      "AnalyticsScript": "<script async defer data-website-id=\"xxx\" src=\"https://analytics.example.com/script.js\"></script>"
    }
  }
  ```

### 前端配置

前端配置文件：`./js/config.js`

#### 隐藏分类配置

通过 `HIDDEN_CATEGORIES` 常量控制哪些分类不在导航栏和分类列表中显示：

- **配置项**：`HIDDEN_CATEGORIES`
- **默认值**：`['pages']`
- **位置**：`NamBlog.Web/js/config.js`
- **说明**：
  - 配置的分类不会在导航栏、分类列表等位置显示
  - 但该分类的文章仍可通过主页列表、标签页、直接链接等方式访问
  - 适用于特殊页面（如"关于"、"隐私声明"等）

- **示例**：
  ```javascript
  // 隐藏多个分类
  export const HIDDEN_CATEGORIES = ['pages', 'drafts', 'private'];
  ```


## 常见问题

### Q1：修改 config.json 后没有生效？
**A**：
- 检查配置项是否正确（JSON 格式、字段名大小写）
- 查看"配置热重载支持"表格，确认该配置是否需要重启应用
- **需要重启的配置**：Admin、Jwt、MCP、FileWatcher
- **支持热重载的配置**：Blog、AI、Cors、Logging
- 查看应用日志确认配置文件是否被加载

### Q2：图标路径 404？
**A**：
- 确认文件存在于 `data/resources/icon/` 目录
- 使用路径格式：`/resources/icon/...`
- 如果没有提供自定义图标的话首次运行会自动从 `wwwroot/images/icon/` 复制默认图标

### Q3：如何重置为默认配置？
**A**：
- 删除 `data/config/config.json`
- 重启应用，系统将使用 `appsettings.json` 中的默认配置

### Q4：Docker 部署时如何配置？
**A**：
- 在宿主机创建 `./data/config/config.json`
- 通过 `-v ./data:/app/data` 映射到容器
- 敏感信息使用环境变量：`-e Jwt__Secret=...`

---

## 详细配置文件说明

### prompts.json - AI 内容生成配置（重点）

`prompts.json` 是最重要的配置文件之一，用于控制后端 AI 内容生成的行为。它定义了系统提示词、资源推荐和验证规则。

**配置位置**：
- 模板文件：`wwwroot/config/prompts.json`
- 实际配置：`data/config/prompts.json`（首次启动自动复制）

**热重载支持**：✅ 完全支持，修改后立即生效

#### 1. Markdown 转 HTML 配置

**核心系统提示词（RootSystemPrompt）**：
- 定义 AI 如何将 Markdown 转换为 HTML
- 包含格式要求、样式原则、安全规则等
- ⚠️ **谨慎修改**：这是整个转换流程的核心指令

**全局用户提示词（UserGlobalPrompt）**：
- 补充用户偏好的样式指导
- 例如："采用现代化扁平设计风格"、"响应式布局，移动端优先"
- 可根据个人喜好自由调整

**外部资源推荐（Resources）**：
- CDN 域名列表（jsDelivr、Cloudflare 等）
- 常用库的 URL 和使用说明（Highlight.js、KaTeX、Mermaid 等）
- 每个资源都包含详细的使用条件和初始化方法
- 💡 **建议**：将常用资源下载到 `data/resources/` 目录，让 AI 优先引用本地资源

**HTML 验证（Validation）**：
- **Mode 验证模式**：
  - `Strict`（严格）：阻止非可信域名的脚本
  - `Warning`（警告，推荐）：记录警告但允许生成
  - `Permissive`（宽松）：不检查外部脚本（不推荐生产环境）
- **CheckExternalScripts**：是否检查外部脚本资源
- **TrustedDomains**：可信 CDN 域名白名单

**配置示例**：
```json
{
  "Prompts": {
    "MarkdownToHtml": {
      "UserGlobalPrompt": "- 采用赛博朋克风格设计\n- 使用霓虹色彩主题\n- 添加矩阵雨背景动画",
      "Resources": [
        {
          "Url": "https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js",
          "Description": "【按需引用】代码高亮库"
        }
      ],
      "Validation": {
        "Mode": "Warning",
        "CheckExternalScripts": true
      }
    }
  }
}
```

#### 2. 元数据自动生成配置

当用户不提供标题、Slug、标签或摘要时，AI 会根据这些提示词自动生成：

- **TitlePrompt**：如何从 Markdown 内容生成文章标题
- **SlugPrompt**：如何从标题生成 URL 友好的 slug
- **TagsPrompt**：如何提取文章相关标签（返回 JSON 数组）
- **ExcerptPrompt**：如何生成文章摘要

**注意事项**：
- 所有提示词都包含严格的长度限制（参考 `Domain/Specifications/ValidationRuleset.cs`）
- 建议设置较小的长度限制，避免生成过长的内容
- 生成的内容必须符合后端验证规则，否则会被拒绝

**自定义示例**：
```json
{
  "MetadataGeneration": {
    "TitlePrompt": "生成一个简洁的技术文章标题，长度不超过50字符。要专业但不要太学术。",
    "TagsPrompt": "提取 3-5 个核心技术标签，每个标签 2-10 字符。返回 JSON 数组，如：[\"Vue3\", \"前端\", \"性能优化\"]"
  }
}
```

#### 3. 修改 prompts.json 的最佳实践

1. **备份原始文件**：修改前先备份 `prompts.json`
2. **逐步调整**：小幅修改并测试效果，不要一次性大改
3. **测试验证**：使用编辑器的"预生成"功能测试 HTML 效果
4. **关注日志**：查看后端日志中的 HTML 验证警告
5. **资源本地化**：将常用 CDN 资源下载到 `data/resources/libs/` 目录，提高加载速度

### mcp-prompts.json - MCP 工具使用指南

`mcp-prompts.json` 为 MCP 客户端（如 Claude Desktop、Cherry Studio）提供提示词模板，指导 AI 如何组合使用博客管理工具。

**配置位置**：
- 模板文件：`wwwroot/config/mcp-prompts.json`
- 实际配置：`data/config/mcp-prompts.json`（首次启动自动复制）

**热重载支持**：✅ 完全支持，修改后立即生效

#### 内置提示词模板

1. **创建博客文章（create_article）**：
   - 指导 AI 如何创建一篇完整的博客文章
   - 包含分类选择、标签设置、HTML 生成等步骤
   - 支持参数：`topic`（文章主题）

2. **优化文章质量（optimize_article）**：
   - 提供文章质量检查清单
   - 指导 AI 检查标题、内容、元数据等方面
   - 包含优化建议和发布流程

3. **文章元数据规范（metadata_guidelines）**：
   - 说明所有字段的验证规则和长度限制
   - 避免提交不符合规范的数据

4. **HTML 提交规范（html_guidelines）**：
   - 手动提交 HTML 时的安全和样式要求
   - 外部资源白名单和验证规则

#### 自定义提示词模板

你可以添加自己的提示词模板，例如：

```json
{
  "prompts": {
    "batch_import": {
      "name": "批量导入文章",
      "description": "从本地 Markdown 文件批量导入文章",
      "template": "请帮我批量导入文章...\n\n步骤：...",
      "parameters": [
        {
          "name": "directory",
          "description": "文件目录路径",
          "required": true
        }
      ]
    }
  }
}
```

#### MCP 客户端使用方式

在支持 MCP 的 AI 客户端中，可以通过以下方式使用这些提示词：

1. 客户端会自动发现并列出所有可用的提示词模板
2. 选择模板后，AI 会根据模板指导自动组合工具调用
3. 用户可以提供参数（如 `topic`）来定制化生成流程

**示例对话**：
```
用户：使用"创建博客文章"模板，主题是"Vue 3 性能优化"
AI：好的，我会按照模板步骤操作：
    1. 先查看现有分类和标签...
    2. 创建文章并设置元数据...
    3. 生成 HTML 版本...
```

### config.json - 博客基本配置

参见前文"用户自定义配置"部分的详细说明。
